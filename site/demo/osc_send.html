<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OSC Send - Popcorn Demo</title>
    <link rel="icon" href="../favicon.svg" type="image/svg+xml" sizes="any">
    <link rel="stylesheet" href="../assets/style.css">
  </head>
  <body>
    <h1>OSC Send</h1>
    <p class="muted">ローカルのElixirブリッジ経由でOSC(UDP)メッセージを送信します（String引数のみ）。</p>

    <div class="nav"></div>

    <section>
      <h3>Settings</h3>
      <div class="row">
        <label>Bridge Server:</label>
        <input id="server" value="http://localhost:8787" size="28">
      </div>
      <div class="row">
        <label>OSC Host:</label>
        <input id="host" value="127.0.0.1" size="20">
      </div>
      <div class="row">
        <label>OSC Port:</label>
        <input id="port" value="9000" size="6">
      </div>
    </section>

    <section>
      <h3>Message</h3>
      <div class="row">
        <label>Address:</label>
        <input id="address" value="/hello" size="20">
      </div>
      <div class="row">
        <label>Arg (string):</label>
        <input id="arg" value="world" size="20">
      </div>
      <div class="row">
        <button id="sendBtn">Send</button>
        <span id="status" class="muted"></span>
      </div>
    </section>

    <section id="logs-pane">
      <h3>Logs</h3>
      <pre id="logs"></pre>
    </section>

    <script type="module">
      import { injectNav } from "../assets/nav.js";
      injectNav();

      const serverEl = document.getElementById("server");
      const hostEl = document.getElementById("host");
      const portEl = document.getElementById("port");
      const addrEl = document.getElementById("address");
      const argEl = document.getElementById("arg");
      const sendBtn = document.getElementById("sendBtn");
      const statusEl = document.getElementById("status");
      const logsEl = document.getElementById("logs");

      function log(line) {
        if (logsEl) logsEl.textContent += line + "\n";
      }
      function setStatus(text, ok) {
        if (!statusEl) return;
        statusEl.textContent = text;
        statusEl.className = ok ? "ok" : "err";
      }

      sendBtn.addEventListener("click", async () => {
        logsEl.textContent = "";
        const server = (serverEl.value || "").replace(/\/+$/, "");
        const host = hostEl.value || "127.0.0.1";
        const port = parseInt(portEl.value, 10) || 9000;
        const address = addrEl.value || "/hello";
        const arg = argEl.value ?? "";
        try {
          const res = await fetch(server + "/osc", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ host, port, address, arg })
          });
          const bodyText = await res.text();
          let body;
          try { body = JSON.parse(bodyText); } catch { body = { raw: bodyText }; }
          if (res.ok && body && body.ok) {
            setStatus("sent", true);
            log(`[ok] address=${address} arg="${arg}" -> ${host}:${port}`);
          } else {
            setStatus("error", false);
            log(`[err] ${res.status} ${res.statusText}`);
            log(String(bodyText));
          }
        } catch (e) {
          setStatus("error", false);
          log("[js err] " + (e && e.message ? e.message : String(e)));
        }
      });
    </script>
  </body>
  </html>

</rewritten_file>

